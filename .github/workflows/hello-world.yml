name: Hello World Python

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Generate matrix
      id: set-matrix
      run: |
        MATRIX=$(python generate_matrix.py)
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
        echo "Generated matrix: $MATRIX"
      env:
        IS_PULL_REQUEST: ${{ github.event_name == 'pull_request' }}

  hello-world:
    needs: generate-matrix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python --version

    - name: Run Hello World script
      run: python hello.py

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: result-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          result.json
          result.html
        retention-days: 30

  aggregate-and-publish:
    needs: hello-world
    runs-on: ubuntu-latest
    if: always()  # Run even if some matrix jobs fail

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Checkout GitHub Pages repository
      if: github.event_name != 'pull_request'
      uses: actions/checkout@v4
      with:
        repository: ggbecker/workflow-testing-pages
        ref: main
        path: gh-pages-content
        token: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}

    - name: Aggregate results and generate HTML
      run: |
        python aggregate_results.py
      env:
        ARTIFACTS_DIR: artifacts
        OUTPUT_DIR: output
        HISTORICAL_DIR: gh-pages-content
        PAGES_URL: https://ggbecker.github.io/workflow-testing-pages
        IS_PULL_REQUEST: ${{ github.event_name == 'pull_request' }}
        PR_NUMBER: ${{ github.event.pull_request.number }}

    - name: Display generated files
      run: |
        echo "Generated files:"
        ls -la output/

    - name: Post summary to GitHub Actions (Push)
      if: github.event_name != 'pull_request'
      run: |
        cat output/summary.md >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“„ **Full Report**: https://ggbecker.github.io/workflow-testing-pages" >> $GITHUB_STEP_SUMMARY

    - name: Post summary to GitHub Actions (PR)
      if: github.event_name == 'pull_request'
      run: |
        echo "# ðŸŽ¯ Pull Request Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **PR Number**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Type**: Fast PR Tests (subset)" >> $GITHUB_STEP_SUMMARY
        echo "- **Environments Tested**: $(find artifacts -name "result.html" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
        echo "All tests passed! âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Note**: Pull requests run a faster subset of tests. Full tests run on push to main." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“„ **Full Historical Results**: https://ggbecker.github.io/workflow-testing-pages" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“„ **PR Test Results**: https://ggbecker.github.io/workflow-testing-pages/pr-tests/" >> $GITHUB_STEP_SUMMARY

    - name: Publish to GitHub Pages repository
      if: github.event_name != 'pull_request'
      uses: peaceiris/actions-gh-pages@v4
      with:
        # IMPORTANT: Create a Personal Access Token with 'repo' scope
        # and add it as a secret named GH_PAGES_DEPLOY_TOKEN
        personal_token: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
        # IMPORTANT: Replace with your GitHub Pages repository
        # Format: username/repository-name
        external_repository: ggbecker/workflow-testing-pages
        publish_branch: main  # or gh-pages, depending on your setup
        publish_dir: ./output
        # Only update index.html and runs/ directory, preserve other files
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Update test results from workflow run #${{ github.run_number }}'

    - name: Publish PR results to GitHub Pages repository
      if: github.event_name == 'pull_request'
      uses: peaceiris/actions-gh-pages@v4
      with:
        personal_token: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}
        external_repository: ggbecker/workflow-testing-pages
        publish_branch: main
        publish_dir: ./output/pr-tests
        destination_dir: pr-tests
        keep_files: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'Update PR #${{ github.event.pull_request.number }} test results'
