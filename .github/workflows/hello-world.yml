name: Hello World Python

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Generate matrix
      id: set-matrix
      run: |
        MATRIX=$(python generate_matrix.py)
        echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
        echo "Generated matrix: $MATRIX"
      env:
        IS_PULL_REQUEST: ${{ github.event_name == 'pull_request' }}

  hello-world:
    needs: generate-matrix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Display Python version
      run: python --version

    - name: Run Hello World script
      run: python hello.py

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: result-${{ matrix.os }}-${{ matrix.python-version }}
        path: |
          result.json
          result.html
        retention-days: 30

  aggregate-and-publish:
    needs: hello-world
    runs-on: ubuntu-latest
    if: always()  # Run even if some matrix jobs fail
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Checkout GitHub Pages repository
      uses: actions/checkout@v4
      with:
        repository: ggbecker/workflow-testing-pages
        ref: main
        path: gh-pages-content
        token: ${{ secrets.GH_PAGES_DEPLOY_TOKEN }}

    - name: Copy existing content to output directory
      run: |
        # Create output directory
        mkdir -p output

        # Copy all existing content from gh-pages-content to output
        # This preserves everything by default
        if [ -d "gh-pages-content" ]; then
          # Copy everything except .git folder (explicitly include hidden files)
          rsync -av --exclude='.git' gh-pages-content/ output/
          echo "Copied existing content to output directory"
          echo "Existing structure:"
          ls -la output/
          echo ""
          echo "Checking if .github was copied:"
          if [ -d "gh-pages-content/.github" ]; then
            echo "âœ“ Source has .github folder"
            if [ -d "output/.github" ]; then
              echo "âœ“ .github folder was copied to output"
            else
              echo "âœ— .github folder was NOT copied to output"
            fi
          else
            echo "Source does not have .github folder"
          fi
        else
          echo "No existing content found"
        fi

    - name: Aggregate results and generate HTML
      run: |
        python aggregate_results.py
      env:
        ARTIFACTS_DIR: artifacts
        OUTPUT_DIR: output
        HISTORICAL_DIR: gh-pages-content
        PAGES_URL: https://ggbecker.github.io/workflow-testing-pages
        IS_PULL_REQUEST: ${{ github.event_name == 'pull_request' }}
        PR_NUMBER: ${{ github.event.pull_request.number }}

    - name: Display generated files
      run: |
        echo "Generated/updated files in output:"
        ls -la output/
        echo ""
        echo "Checking for .github folder in output:"
        if [ -d "output/.github" ]; then
          echo "âœ“ .github folder exists in output"
          ls -la output/.github/
          if [ -d "output/.github/workflows" ]; then
            echo "âœ“ .github/workflows folder exists"
            ls -la output/.github/workflows/
          else
            echo "âœ— .github/workflows folder NOT found in output"
          fi
        else
          echo "âœ— .github folder NOT found in output"
        fi

    - name: Post summary to GitHub Actions (Push)
      if: github.event_name != 'pull_request'
      run: |
        cat output/summary.md >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **[View Dashboard](https://ggbecker.github.io/workflow-testing-pages)** | **[View All Full Tests](https://ggbecker.github.io/workflow-testing-pages/full-tests/)**" >> $GITHUB_STEP_SUMMARY

    - name: Post summary to GitHub Actions (PR)
      if: github.event_name == 'pull_request'
      run: |
        # Find the timestamp folder (latest one created in output/pr-tests/)
        TIMESTAMP_FOLDER=$(ls -t output/pr-tests/ | grep -E '^[0-9]' | head -1)

        echo "# ðŸŽ¯ Pull Request Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **PR Number**: #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Type**: Fast PR Tests (subset)" >> $GITHUB_STEP_SUMMARY
        echo "- **Environments Tested**: $(find artifacts -name "result.html" | wc -l)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ðŸ“Š Results" >> $GITHUB_STEP_SUMMARY
        echo "All tests passed! âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Note**: Pull requests run a faster subset of tests. Full tests run on push to main." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“„ **[View This Run's Results](https://ggbecker.github.io/workflow-testing-pages/pr-tests/$TIMESTAMP_FOLDER/)**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“„ **[View All PR Test Runs](https://ggbecker.github.io/workflow-testing-pages/pr-tests/)**" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š **[View Dashboard](https://ggbecker.github.io/workflow-testing-pages)**" >> $GITHUB_STEP_SUMMARY

    - name: Copy output files back to gh-pages-content
      run: |
        echo "Copying output files back to gh-pages-content..."
        # Copy everything from output back to gh-pages-content (excluding .git)
        rsync -av --exclude='.git' output/ gh-pages-content/
        echo "Files copied back to gh-pages-content"

        echo "Final content structure:"
        ls -la gh-pages-content/

    - name: Commit and push changes to workflow-testing-pages
      working-directory: gh-pages-content
      run: |
        # Configure git
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'

        # Add all changes
        git add .

        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          # Create commit message
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            COMMIT_MSG="Update PR #${{ github.event.pull_request.number }} test results"
          else
            COMMIT_MSG="Update test results from workflow run #${{ github.run_number }}"
          fi

          # Commit and push
          git commit -m "$COMMIT_MSG"
          git push
          echo "Changes pushed to workflow-testing-pages"
        fi

    - name: Comment on PR with test results
      if: github.event_name == 'pull_request'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Count the number of test results
        NUM_TESTS=$(find artifacts -name "result.html" | wc -l)

        # Find the timestamp folder (latest one created in output/pr-tests/)
        TIMESTAMP_FOLDER=$(ls -t output/pr-tests/ | grep -E '^[0-9]' | head -1)

        # Create comment body
        cat > pr-comment.md << 'EOF'
        ## ðŸŽ¯ Test Results - PR #PR_NUMBER_PLACEHOLDER

        ### Summary
        - âœ… **Status**: All tests passed
        - ðŸ”¬ **Environments Tested**: NUM_TESTS_PLACEHOLDER
        - âš¡ **Test Type**: Fast PR Tests (subset)
        - ðŸ”— **Workflow Run**: [#RUN_NUMBER_PLACEHOLDER](https://github.com/REPOSITORY_PLACEHOLDER/actions/runs/RUN_ID_PLACEHOLDER)

        ### ðŸ“Š Detailed Results

        View the complete test results for this PR:
        ðŸ‘‰ **[View This Run's Results](https://ggbecker.github.io/workflow-testing-pages/pr-tests/TIMESTAMP_PLACEHOLDER/)**

        ðŸ“‹ **[View All PR Test Runs](https://ggbecker.github.io/workflow-testing-pages/pr-tests/)**

        ### â„¹ï¸ About These Tests

        This pull request runs a **faster subset of tests** for quick feedback:
        - **Platforms**: Ubuntu Latest
        - **Python Versions**: 3.11, 3.12

        Full comprehensive tests (all platforms and Python versions) will run when this PR is merged to main.

        ---

        <sub>ðŸ¤– Generated by GitHub Actions | [View Dashboard](https://ggbecker.github.io/workflow-testing-pages/) | [View Full Tests](https://ggbecker.github.io/workflow-testing-pages/full-tests/)</sub>
        EOF

        # Replace placeholders
        sed -i "s/PR_NUMBER_PLACEHOLDER/${{ github.event.pull_request.number }}/g" pr-comment.md
        sed -i "s/NUM_TESTS_PLACEHOLDER/$NUM_TESTS/g" pr-comment.md
        sed -i "s|TIMESTAMP_PLACEHOLDER|$TIMESTAMP_FOLDER|g" pr-comment.md
        sed -i "s/RUN_NUMBER_PLACEHOLDER/${{ github.run_number }}/g" pr-comment.md
        sed -i "s|REPOSITORY_PLACEHOLDER|${{ github.repository }}|g" pr-comment.md
        sed -i "s/RUN_ID_PLACEHOLDER/${{ github.run_id }}/g" pr-comment.md

        # Post comment to PR
        gh pr comment ${{ github.event.pull_request.number }} --body-file pr-comment.md
